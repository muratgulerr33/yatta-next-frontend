# Nginx Cache Proxy Configuration for Next.js SSR
# Bu dosya /etc/nginx/sites-enabled/yatta.com.tr içine eklenmeli

# Cache zone tanımlaması (http bloğunda)
# http {
#   proxy_cache_path /var/cache/nginx/nextjs levels=1:2 keys_zone=nextjs_cache:10m max_size=1g inactive=60m use_temp_path=off;
# }

server {
  server_name yatta.com.tr;
  listen 80;
  listen 443 ssl http2;

  # SSL direktifleri certbot tarafından yönetilecek

  # Cache zone kullanımı için proxy_cache_path tanımlanmalı (http bloğunda)
  # proxy_cache nextjs_cache;
  # proxy_cache_valid 200 60m;
  # proxy_cache_valid 404 1m;
  # proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
  # proxy_cache_background_update on;
  # proxy_cache_lock on;

  # Static assets için agresif cache (_next/static)
  location /_next/static/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Cache headers (Next.js zaten ekliyor ama Nginx de ekleyebilir)
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    
    # Gzip compression
    gzip on;
    gzip_types text/css application/javascript image/svg+xml;
    gzip_vary on;
  }

  # Image optimization endpoint (_next/image)
  location /_next/image/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Image cache
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    
    # Gzip (metadata için)
    gzip on;
    gzip_types application/json;
  }

  # Favicon ve public assets
  location ~* \.(ico|png|jpg|jpeg|gif|svg|webp|avif|woff|woff2|ttf|eot)$ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    
    # Public assets cache
    add_header Cache-Control "public, max-age=86400, s-maxage=86400" always;
    
    # Gzip compression
    gzip on;
    gzip_types image/svg+xml font/woff font/woff2 font/ttf font/eot;
    gzip_vary on;
  }

  # Health endpoint (no cache - her zaman fresh)
  location = /health {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # No cache for health checks
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }

  # Webhook endpoint (no cache)
  location = /webhook {
    proxy_pass http://127.0.0.1:9000;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Webhook timeout (GitHub 10sn limit)
    proxy_connect_timeout 12s;
    proxy_send_timeout 12s;
    proxy_read_timeout 12s;
    
    # No cache
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  }

  # SSR pages (dynamic content - limited cache)
  location / {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;     # WebSocket/Hot reload
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    
    proxy_pass http://127.0.0.1:3000;
    
    # Dynamic content için kısa cache (Next.js ISR ile uyumlu)
    # Nginx cache kullanmak isterseniz:
    # proxy_cache nextjs_cache;
    # proxy_cache_valid 200 5m;
    # proxy_cache_bypass $http_cache_control;
    
    # Gzip compression (HTML, JSON, CSS, JS)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
  }
}

