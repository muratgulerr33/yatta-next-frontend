name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  NEXT_PUBLIC_API_BASE_URL: https://api.yatta.com.tr

jobs:
  # Lint ve Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Check for build errors
        run: npm run build --dry-run || npm run build 2>&1 | head -50

  # Build Test
  build:
    name: Build Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: ${{ env.NEXT_PUBLIC_API_BASE_URL }}
      
      - name: Check build artifacts
        run: |
          if [ ! -d ".next/standalone" ]; then
            echo "‚ùå Standalone build not found"
            exit 1
          fi
          echo "‚úÖ Build artifacts found"
          ls -la .next/standalone | head -10

  # Health Check (Production deploy √∂ncesi)
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Check API health
        run: |
          echo "Checking API health..."
          curl -f https://api.yatta.com.tr/health/ping || echo "‚ö†Ô∏è API health check failed"
      
      - name: Check Frontend health
        run: |
          echo "Checking frontend health..."
          curl -f https://yatta.com.tr/health || echo "‚ö†Ô∏è Frontend health check failed"

  # Deploy (Manual trigger veya main branch push)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint, build, health-check]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://yatta.com.tr
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy notification
        run: |
          echo "üöÄ Deployment triggered"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: Webhook deployment
        run: |
          echo "‚ö†Ô∏è Manual deployment via webhook server required"
          echo "Webhook URL: https://yatta.com.tr/webhook"
          echo "Use webhook server for actual deployment"

